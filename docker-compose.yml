version: '3.9'
services:
  api:
    image: ${DOCKER_REGISTRY}${IMAGE_PREFIX}api:${DOCKER_TAG}
    build:
      context: ./
      dockerfile: ./build/Dockerfile
    networks:
      - schism
    environment:
      - BUILD_ENV=${BUILD_ENV}
      - GIT_COMMIT=${GIT_COMMIT}
      - GIT_TAG=${GIT_TAG}
    secrets:
      - source: schism.api.secret
        uid: '999'
        mode: 0400
    deploy:
      labels:
      - "traefik.enable=true"
      - "traefik.docker.network=schism_frontend"
      - "traefik.frontend.rule=schism.${DOMAIN}"
      - "traefik.port=80"
    volumes:
      - sqlite:/db:rw

volumes:
  sqlite:

networks:
  schism:

secrets:
  schism.api.secret:
    file: .secrets/schism.api.secret